<!-- if i break da code, return to this version -->

{% extends 'nav.html' %}

{% block content %}

{% from 'mazegenerate.html' import generate_modal %}
{{ generate_modal(room_types) }}

<div class="modal fade" id="maze-name-modal" tabindex="-1" aria-labelledby="modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modal-label">Name This Maze!</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="maze-name" class="col-form-label">Maze Name:</label>
            <input type="text" class="form-control" id="maze-name">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="save_maze()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Tooltip for room description -->
<div id="room-tooltip" class="position-fixed bg-dark text-white p-3 rounded shadow" style="display: none; z-index: 1000; max-width: 300px;"></div>

<div class="container my-5 text-center">
  <p id="error-text" class="text-center bg-danger text-white" hidden>Could not Save to Server!</p>
  <h2 class="display-4 fw-bold">Your Maze</h2>

  <script>
    const roomData = {{ maze | tojson }};
  </script>

  <img id="maze-image" src="{{ image }}" class="my-3 rounded shadow-lg" alt="Maze Image">

  <div class="mt-3">
    <button class="btn btn-primary btn-lg me-2" onclick="download()">Save Maze Locally</button>
    <button class="btn btn-success btn-lg me-2" data-bs-toggle="modal" data-bs-target="#maze-name-modal">Save Maze to Server</button>
    <a class="btn btn-secondary btn-lg me-2" href="/maze/randomize">Generate Random Maze</a>
    <button class="btn btn-secondary btn-lg" data-bs-toggle="modal" data-bs-target="#customMazeModal">Generate Maze</button>
  </div>
</div>

<script>
  const tooltip = document.getElementById('room-tooltip');
  const image = document.getElementById('maze-image');

  const squareWidth = image.width / {{ x }};
  const squareHeight = image.height / {{ y }};

  image.addEventListener('mousemove', function (event) {
    const rect = image.getBoundingClientRect();
    const offsetX = event.clientX - rect.left;
    const offsetY = event.clientY - rect.top;
    const gridX = Math.floor(offsetX / squareWidth);
    const gridY = Math.floor(offsetY / squareHeight);

    const matches = roomData.filter(r => gridX >= r.x && gridX < r.x2 && gridY >= r.y && gridY < r.y2);

    if (matches.length > 0) {
      tooltip.innerHTML = matches.map(r => r.description).join("<hr>");
      tooltip.style.display = 'block';

      let tooltipX = event.clientX + 10;
      let tooltipY = event.clientY + 10;
      const tooltipRect = tooltip.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;

      if (tooltipX + tooltipRect.width > vw) tooltipX -= tooltipRect.width + 20;
      if (tooltipY + tooltipRect.height > vh) tooltipY -= tooltipRect.height + 20;

      tooltip.style.left = tooltipX + 'px';
      tooltip.style.top = tooltipY + 'px';
    } else {
      tooltip.style.display = 'none';
    }
  });

  image.addEventListener('mouseout', function () {
    tooltip.style.display = 'none';
  });

  const download = () => {
    const a = document.createElement("a");
    const file = new Blob(['{"seed": "{{seed}}", "x": "{{x}}", "y": "{{y}}", "args": "{{args}}"}'], { type: 'application/json' });
    a.href = URL.createObjectURL(file);
    a.download = 'maze.json';
    a.click();
  };

  const save_maze = () => {
    fetch('/save-maze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: document.querySelector('#maze-name').value,
        x: {{ x }},
        y: {{ y }},
        seed: {{ seed }},
        args: "{{ args }}"
      })
    })
    .then(res => res.json())
    .then(data => {
      document.querySelector('#error-text').hidden = data['success'];
    });
  };
</script>

{% endblock %}
